pipeline{
    agent any
          parameters {
          choice(name: 'TerraformAction', choices: 'Deploy\nDestroy', description: 'Select the action to perform')
                   }
          environment {
          CLOUDSDK_CORE_PROJECT='devops-project-1-419603'    
          GCP_SERVICE_ACCOUNT = credentials('gce-secret-key') 
                   }
    stages{
           stage('Git checkout'){
              steps{
              git credentialsId: 'jenkins-personal-access-token', url: 'https://github.com/mshan011181/Terraform-jenkins-gcp.git'
                     }
                  }
           stage('Initialize'){                  
                          when {
                          expression {
                         // return params.TerraformAction == 'Deploy'
                         return params.TerraformAction == 'Deploy' || params.TerraformAction == 'Destroy'
                                     }    
                            }
                         steps{ 
                         sh '''
                         export GOOGLE_APPLICATION_CREDENTIALS=/home/shandba90/jenkins-gce.json
                         terraform init -reconfigure                                  
                         '''
                             }
                     }
          stage('Plan'){
                          when {
                          expression {
                         // return params.TerraformAction == 'Deploy'
                         return params.TerraformAction == 'Deploy' || params.TerraformAction == 'Destroy'
                             }
                          } 
                          steps{ 
                          sh '''
                          export GOOGLE_APPLICATION_CREDENTIALS=/home/shandba90/jenkins-gce.json 
                          terraform plan
                          ''' 
                             }
                    }
        stage('Apply'){
                          when {
                          expression {
                          return params.TerraformAction == 'Deploy'
                             }
                          } 
                          steps{   
                          sh '''
                          export GOOGLE_APPLICATION_CREDENTIALS=/home/shandba90/jenkins-gce.json
                          terraform apply -auto-approve
                            ''' 
                             }
                    }
      

        stage('destroy'){
                           when {
                          expression {
                          return params.TerraformAction == 'Destroy'
                                  }    
                            }  
                           steps{               
                           sh ''' 
                             export GOOGLE_APPLICATION_CREDENTIALS=/home/shandba90/jenkins-gce.json 
                             terraform state list
                             terraform state rm google_project_service.compute_service
                             terraform destroy -auto-approve
                            '''
                                 }
                       }
        }
}
